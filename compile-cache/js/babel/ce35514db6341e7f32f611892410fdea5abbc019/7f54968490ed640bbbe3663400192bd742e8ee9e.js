Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.activate = activate;
exports.deactivate = deactivate;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _atom = require('atom');

var _coreJsLibrary = require('core-js/library');

var _coreJsLibrary2 = _interopRequireDefault(_coreJsLibrary);

'use babel';

var find = _coreJsLibrary2['default'].Array.prototype.find;

var disposables = [];

var Lang = function Lang(rLangScope, openCommentToken, closeCommentToken) {
  return {
    test: function test(scope) {
      return rLangScope.test(scope);
    },
    commentTokens: { open: openCommentToken, close: closeCommentToken }
  };
};
var langs = [Lang(/^source\.js\.?/, '/*', '*/'), Lang(/^source\.css\.?/, '/*', '*/'), Lang(/^source\.php\.?/, '/*', '*/'), Lang(/^text\.html\.?/, '<!--', '-->'), Lang(/^source\.python\.?/, "'''", "'''")];

var config = {
  pad: {
    title: 'Pad with spaces',
    description: 'Pad selection with whitespace when commenting.',
    type: 'boolean',
    'default': false
  }
};

exports.config = config;

function activate() {
  disposables.push(atom.commands.add('atom-text-editor:not([mini])', { 'sublime-block-comment:toggle': toggle }));
}

function deactivate() {
  for (var disposable of disposables) {
    disposable.dispose();
  }disposables.length = 0;
}

function toggle() {
  var editor = atom.workspace.getActiveTextEditor();
  if (!editor) return;

  var buffer = editor.getBuffer();
  var padding = atom.config.get('sublime-block-comment.pad') ? ' ' : '';

  buffer.transact(function () {
    for (var selection of editor.getSelectionsOrderedByBufferPosition().reverse()) {
      var range = selection.getBufferRange();
      var textInRange = buffer.getTextInRange(range);
      var scopes = getPositionScopes(range.start).reverse();

      var lang = undefined;
      if (!scopes.some(function (scope) {
        return lang = find.call(langs, function (lang) {
          return lang.test(scope);
        });
      })) lang = langs[0];
      var commentTokens = lang.commentTokens;

      // If we are inside a block comment or have one fully or partially selected, uncomment it.
      if ((isInsideBlockComment(range.start) || isAtCloseCommentToken(range.start, commentTokens.close)) && (isInsideBlockComment(range.end) || isAtCloseCommentToken(range.end, commentTokens.close)) && ~[-1, textInRange.length - commentTokens.close.length].indexOf(textInRange.indexOf(commentTokens.close))) {
        var blockCommentCloseRange = undefined;
        var lastRow = buffer.getLastRow();
        for (var row = range.end.row; !blockCommentCloseRange && row <= lastRow; row++) {
          var line = buffer.lineForRow(row);
          for (var column = row === range.end.row ? Math.max(range.end.column - commentTokens.close.length + (
          // Python has the same tokens for block string begin and end, so we need an extra sanity check.
          // This logic would not work with JavaScript anyway as it the comment begin/end tokens don't have dedicated scopes.
          isPythonStringBlockBegin(range.end) ? commentTokens.open.length + 1 : 0), 0) : 0; (column = line.indexOf(commentTokens.close, column)) !== -1; column++) {
            if (isCommentDefinitionPunctuation([row, column])) {
              blockCommentCloseRange = new _atom.Range([row, column], [row, column + commentTokens.close.length]);
              break;
            }
          }
        }

        var blockCommentOpenRange = undefined;
        for (var row = range.start.row; !blockCommentOpenRange && row >= 0; row--) {
          var line = buffer.lineForRow(row);
          for (var column = row === range.start.row ? blockCommentCloseRange && row === blockCommentCloseRange.start.row
          // Python has the same tokens for block string begin and end, so we need an extra sanity check.
          // If end token is at the beginning of a line (column 0), skip to the line above to avoid matching the end token as the begin token as well.
          ? blockCommentCloseRange.start.column - 1 > 0 ? blockCommentCloseRange.start.column - 1 : (--row, line = buffer.lineForRow(row), line.length) : Math.min(range.start.column + commentTokens.open.length, line.length) : line.length; (column = line.lastIndexOf(commentTokens.open, column)) !== -1; column--) {
            if (isCommentDefinitionPunctuation([row, column])) {
              blockCommentOpenRange = new _atom.Range([row, column], [row, column + commentTokens.open.length]);
              break;
            }
          }
        }

        if (blockCommentCloseRange) {
          if (padding) {
            var blockCommentClosePaddedRangeStart = new _atom.Point(blockCommentCloseRange.start.row, blockCommentCloseRange.start.column - padding.length);
            if ((!blockCommentOpenRange || blockCommentClosePaddedRangeStart.compare(blockCommentOpenRange.end) >= 0) && buffer.getTextInRange([blockCommentClosePaddedRangeStart, blockCommentCloseRange.start]) === padding) {
              blockCommentCloseRange.start = blockCommentClosePaddedRangeStart;
            }
          }
          buffer['delete'](blockCommentCloseRange);
        }

        if (blockCommentOpenRange) {
          if (padding) {
            var blockCommentOpenPaddedRangeEnd = new _atom.Point(blockCommentOpenRange.end.row, blockCommentOpenRange.end.column + padding.length);
            if (
            // This sanity check also prevents excessively removing "overlapping" start/end padding.
            // E.g.: "/* */ a" => " a" instead of "a"
            (!blockCommentCloseRange || blockCommentOpenPaddedRangeEnd.compare(blockCommentCloseRange.start) <= 0) && buffer.getTextInRange([blockCommentOpenRange.end, blockCommentOpenPaddedRangeEnd]) === padding) {
              blockCommentOpenRange.end = blockCommentOpenPaddedRangeEnd;
            }
          }
          buffer['delete'](blockCommentOpenRange);
        }

        continue;
      }

      // Else, wrap selection with block comment.
      buffer.insert(range.end, padding + commentTokens.close);
      buffer.insert(range.start, commentTokens.open + padding);

      // Unselect the opening and closing comment tokens.
      var startRowColumnOffset = commentTokens.open.length + padding.length;
      selection.setBufferRange([[range.start.row, range.start.column + startRowColumnOffset], [range.end.row, range.end.column + (range.start.row === range.end.row ? startRowColumnOffset : 0)]]);
    }
  });

  function isInsideBlockComment(position) {
    var scopes = getPositionScopes(position);
    var commentScopePrefix = (isPythonSource(scopes) ? 'string.quoted.single' : 'comment') + '.block.';
    return scopes.some(function (scope) {
      return scope.startsWith(commentScopePrefix);
    });
  }

  function isCommentDefinitionPunctuation(position) {
    var scopes = getPositionScopes(position);
    var commentPunctuationScopePrefix = 'punctuation.definition.' + (isPythonSource(scopes) ? 'string' : 'comment') + '.';
    return scopes.some(function (scope) {
      return scope.startsWith(commentPunctuationScopePrefix);
    });
  }

  function getPositionScopes(position) {
    return editor.scopeDescriptorForBufferPosition(position).getScopesArray();
  }

  function isAtCloseCommentToken(position, closeCommentToken) {
    return position.column >= closeCommentToken.length && buffer.getTextInRange([[position.row, position.column - closeCommentToken.length], position]) === closeCommentToken && isCommentDefinitionPunctuation([position.row, position.column - 1]);
  }

  function isPythonSource(scopes) {
    return scopes[0] === 'source.python';
  }

  function isPythonPunctuationDefinitionStringBegin(scope) {
    return scope === 'punctuation.definition.string.begin.python';
  }

  function isPythonStringBlockBegin(position) {
    return isInsideBlockComment(position) && (getPositionScopes(position).some(isPythonPunctuationDefinitionStringBegin) ||
    // Atom does not identify the position at the end of the begin token as part of its scope, therefore we check one column to the left as well.
    position.column > 0 && getPositionScopes([position.row, position.column - 1]).some(isPythonPunctuationDefinitionStringBegin));
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2x1aXouY2FycmFyby8uYXRvbS9wYWNrYWdlcy9zdWJsaW1lLWJsb2NrLWNvbW1lbnQvbGliL3N1YmxpbWUtYmxvY2stY29tbWVudC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7OztvQkFFNkIsTUFBTTs7NkJBRWxCLGlCQUFpQjs7OztBQUpsQyxXQUFXLENBQUM7O0lBS0osSUFBSSxHQUFLLDJCQUFLLEtBQUssQ0FBQyxTQUFTLENBQTdCLElBQUk7O0FBRVosSUFBTSxXQUFXLEdBQUcsRUFBRSxDQUFDOztBQUV2QixJQUFNLElBQUksR0FBRyxTQUFQLElBQUksQ0FBSSxVQUFVLEVBQUUsZ0JBQWdCLEVBQUUsaUJBQWlCO1NBQU07QUFDakUsUUFBSSxFQUFFLGNBQUMsS0FBSzthQUFLLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDO0tBQUE7QUFDdkMsaUJBQWEsRUFBRSxFQUFFLElBQUksRUFBRSxnQkFBZ0IsRUFBRSxLQUFLLEVBQUUsaUJBQWlCLEVBQUU7R0FDcEU7Q0FBQyxDQUFDO0FBQ0gsSUFBTSxLQUFLLEdBQUcsQ0FDWixJQUFJLENBQUMsZ0JBQWdCLEVBQUssSUFBSSxFQUFJLElBQUksQ0FBRSxFQUN4QyxJQUFJLENBQUMsaUJBQWlCLEVBQUksSUFBSSxFQUFJLElBQUksQ0FBRSxFQUN4QyxJQUFJLENBQUMsaUJBQWlCLEVBQUksSUFBSSxFQUFJLElBQUksQ0FBRSxFQUN4QyxJQUFJLENBQUMsZ0JBQWdCLEVBQUssTUFBTSxFQUFFLEtBQUssQ0FBQyxFQUN4QyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUN6QyxDQUFDOztBQUVLLElBQU0sTUFBTSxHQUFHO0FBQ3BCLEtBQUcsRUFBRTtBQUNILFNBQUssRUFBRSxpQkFBaUI7QUFDeEIsZUFBVyxFQUFFLGdEQUFnRDtBQUM3RCxRQUFJLEVBQUUsU0FBUztBQUNmLGVBQVMsS0FBSztHQUNmO0NBQ0YsQ0FBQzs7OztBQUVLLFNB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LENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQyxLQUFLLGlCQUFpQixJQUNuSCw4QkFBOEIsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0dBQzFFOztBQUVELFdBQVMsY0FBYyxDQUFDLE1BQU0sRUFBRTtBQUM5QixXQUFPLE1BQU0sQ0FBQyxDQUFDLENBQUMsS0FBSyxlQUFlLENBQUM7R0FDdEM7O0FBRUQsV0FBUyx3Q0FBd0MsQ0FBQyxLQUFLLEVBQUU7QUFDdkQsV0FBTyxLQUFLLEtBQUssNENBQTRDLENBQUM7R0FDL0Q7O0FBRUQsV0FBUyx3QkFBd0IsQ0FBQyxRQUFRLEVBQUU7QUFDMUMsV0FBTyxvQkFBb0IsQ0FBQyxRQUFRLENBQUMsS0FDbkMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLHdDQUF3QyxDQUFDOztBQUV6RSxZQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxpQkFBaUIsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFDLEFBQy9ILENBQUM7R0FDSDtDQUNGIiwiZmlsZSI6Ii9ob21lL2x1aXouY2FycmFyby8uYXRvbS9wYWNrYWdlcy9zdWJsaW1lLWJsb2NrLWNvbW1lbnQvbGliL3N1YmxpbWUtYmxvY2stY29tbWVudC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuXG5pbXBvcnQgeyBQb2ludCwgUmFuZ2UgfSBmcm9tICdhdG9tJztcblxuaW1wb3J0IGNvcmUgZnJvbSAnY29yZS1qcy9saWJyYXJ5JztcbmNvbnN0IHsgZmluZCB9ID0gY29yZS5BcnJheS5wcm90b3R5cGU7XG5cbmNvbnN0IGRpc3Bvc2FibGVzID0gW107XG5cbmNvbnN0IExhbmcgPSAockxhbmdTY29wZSwgb3BlbkNvbW1lbnRUb2tlbiwgY2xvc2VDb21tZW50VG9rZW4pID0+ICh7XG4gIHRlc3Q6IChzY29wZSkgPT4gckxhbmdTY29wZS50ZXN0KHNjb3BlKSxcbiAgY29tbWVudFRva2VuczogeyBvcGVuOiBvcGVuQ29tbWVudFRva2VuLCBjbG9zZTogY2xvc2VDb21tZW50VG9rZW4gfSxcbn0pO1xuY29uc3QgbGFuZ3MgPSBbXG4gIExhbmcoL15zb3VyY2VcXC5qc1xcLj8vICwgICAnLyonICAsICcqLycgKSxcbiAgTGFuZygvXnNvdXJjZVxcLmNzc1xcLj8vLCAgICcvKicgICwgJyovJyApLFxuICBMYW5nKC9ec291cmNlXFwucGhwXFwuPy8sICAgJy8qJyAgLCAnKi8nICksXG4gIExhbmcoL150ZXh0XFwuaHRtbFxcLj8vICwgICAnPCEtLScsICctLT4nKSxcbiAgTGFuZygvXnNvdXJjZVxcLnB5dGhvblxcLj8vLCBcIicnJ1wiLCBcIicnJ1wiKSxcbl07XG5cbmV4cG9ydCBjb25zdCBjb25maWcgPSB7XG4gIHBhZDoge1xuICAgIHRpdGxlOiAnUGFkIHdpdGggc3BhY2VzJyxcbiAgICBkZXNjcmlwdGlvbjogJ1BhZCBzZWxlY3Rpb24gd2l0aCB3aGl0ZXNwYWNlIHdoZW4gY29tbWVudGluZy4nLFxuICAgIHR5cGU6ICdib29sZWFuJyxcbiAgICBkZWZhdWx0OiBmYWxzZSxcbiAgfSxcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBhY3RpdmF0ZSgpIHtcbiAgZGlzcG9zYWJsZXMucHVzaChhdG9tLmNvbW1hbmRzLmFkZCgnYXRvbS10ZXh0LWVkaXRvcjpub3QoW21pbmldKScsIHsgJ3N1YmxpbWUtYmxvY2stY29tbWVudDp0b2dnbGUnOiB0b2dnbGUgfSkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVhY3RpdmF0ZSgpIHtcbiAgZm9yIChjb25zdCBkaXNwb3NhYmxlIG9mIGRpc3Bvc2FibGVzKSBkaXNwb3NhYmxlLmRpc3Bvc2UoKTtcbiAgZGlzcG9zYWJsZXMubGVuZ3RoID0gMDtcbn1cblxuZnVuY3Rpb24gdG9nZ2xlKCkge1xuICBjb25zdCBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCk7XG4gIGlmICghZWRpdG9yKSByZXR1cm47XG5cbiAgY29uc3QgYnVmZmVyID0gZWRpdG9yLmdldEJ1ZmZlcigpO1xuICBjb25zdCBwYWRkaW5nID0gYXRvbS5jb25maWcuZ2V0KCdzdWJsaW1lLWJsb2NrLWNvbW1lbnQucGFkJykgPyAnICcgOiAnJztcblxuICBidWZmZXIudHJhbnNhY3QoKCkgPT4ge1xuICAgIGZvciAoY29uc3Qgc2VsZWN0aW9uIG9mIGVkaXRvci5nZXRTZWxlY3Rpb25zT3JkZXJlZEJ5QnVmZmVyUG9zaXRpb24oKS5yZXZlcnNlKCkpIHtcbiAgICAgIGNvbnN0IHJhbmdlID0gc2VsZWN0aW9uLmdldEJ1ZmZlclJhbmdlKCk7XG4gICAgICBjb25zdCB0ZXh0SW5SYW5nZSA9IGJ1ZmZlci5nZXRUZXh0SW5SYW5nZShyYW5nZSk7XG4gICAgICBjb25zdCBzY29wZXMgPSBnZXRQb3NpdGlvblNjb3BlcyhyYW5nZS5zdGFydCkucmV2ZXJzZSgpO1xuXG4gICAgICBsZXQgbGFuZztcbiAgICAgIGlmICghc2NvcGVzLnNvbWUoKHNjb3BlKSA9PiBsYW5nID0gbGFuZ3M6OmZpbmQoKGxhbmcpID0+IGxhbmcudGVzdChzY29wZSkpKSkgbGFuZyA9IGxhbmdzWzBdO1xuICAgICAgY29uc3QgY29tbWVudFRva2VucyA9IGxhbmcuY29tbWVudFRva2VucztcblxuICAgICAgLy8gSWYgd2UgYXJlIGluc2lkZSBhIGJsb2NrIGNvbW1lbnQgb3IgaGF2ZSBvbmUgZnVsbHkgb3IgcGFydGlhbGx5IHNlbGVjdGVkLCB1bmNvbW1lbnQgaXQuXG4gICAgICBpZiAoXG4gICAgICAgIChpc0luc2lkZUJsb2NrQ29tbWVudChyYW5nZS5zdGFydCkgfHwgaXNBdENsb3NlQ29tbWVudFRva2VuKHJhbmdlLnN0YXJ0LCBjb21tZW50VG9rZW5zLmNsb3NlKSlcbiAgICAgICAgJiYgKGlzSW5zaWRlQmxvY2tDb21tZW50KHJhbmdlLmVuZCkgfHwgaXNBdENsb3NlQ29tbWVudFRva2VuKHJhbmdlLmVuZCwgY29tbWVudFRva2Vucy5jbG9zZSkpXG4gICAgICAgICYmIH5bLTEsIHRleHRJblJhbmdlLmxlbmd0aCAtIGNvbW1lbnRUb2tlbnMuY2xvc2UubGVuZ3RoXS5pbmRleE9mKHRleHRJblJhbmdlLmluZGV4T2YoY29tbWVudFRva2Vucy5jbG9zZSkpXG4gICAgICApIHtcbiAgICAgICAgbGV0IGJsb2NrQ29tbWVudENsb3NlUmFuZ2U7XG4gICAgICAgIGNvbnN0IGxhc3RSb3cgPSBidWZmZXIuZ2V0TGFzdFJvdygpO1xuICAgICAgICBmb3IgKGxldCByb3cgPSByYW5nZS5lbmQucm93OyAhYmxvY2tDb21tZW50Q2xvc2VSYW5nZSAmJiByb3cgPD0gbGFzdFJvdzsgcm93KyspIHtcbiAgICAgICAgICBjb25zdCBsaW5lID0gYnVmZmVyLmxpbmVGb3JSb3cocm93KTtcbiAgICAgICAgICBmb3IgKFxuICAgICAgICAgICAgbGV0IGNvbHVtbiA9IHJvdyA9PT0gcmFuZ2UuZW5kLnJvd1xuICAgICAgICAgICAgICA/IE1hdGgubWF4KHJhbmdlLmVuZC5jb2x1bW4gLSBjb21tZW50VG9rZW5zLmNsb3NlLmxlbmd0aCArIChcbiAgICAgICAgICAgICAgICAvLyBQeXRob24gaGFzIHRoZSBzYW1lIHRva2VucyBmb3IgYmxvY2sgc3RyaW5nIGJlZ2luIGFuZCBlbmQsIHNvIHdlIG5lZWQgYW4gZXh0cmEgc2FuaXR5IGNoZWNrLlxuICAgICAgICAgICAgICAgIC8vIFRoaXMgbG9naWMgd291bGQgbm90IHdvcmsgd2l0aCBKYXZhU2NyaXB0IGFueXdheSBhcyBpdCB0aGUgY29tbWVudCBiZWdpbi9lbmQgdG9rZW5zIGRvbid0IGhhdmUgZGVkaWNhdGVkIHNjb3Blcy5cbiAgICAgICAgICAgICAgICBpc1B5dGhvblN0cmluZ0Jsb2NrQmVnaW4ocmFuZ2UuZW5kKVxuICAgICAgICAgICAgICAgICAgPyBjb21tZW50VG9rZW5zLm9wZW4ubGVuZ3RoICsgMVxuICAgICAgICAgICAgICAgICAgOiAwXG4gICAgICAgICAgICAgICksIDApXG4gICAgICAgICAgICAgIDogMDtcbiAgICAgICAgICAgIChjb2x1bW4gPSBsaW5lLmluZGV4T2YoY29tbWVudFRva2Vucy5jbG9zZSwgY29sdW1uKSkgIT09IC0xO1xuICAgICAgICAgICAgY29sdW1uKytcbiAgICAgICAgICApIHtcbiAgICAgICAgICAgIGlmIChpc0NvbW1lbnREZWZpbml0aW9uUHVuY3R1YXRpb24oW3JvdywgY29sdW1uXSkpIHtcbiAgICAgICAgICAgICAgYmxvY2tDb21tZW50Q2xvc2VSYW5nZSA9IG5ldyBSYW5nZShbcm93LCBjb2x1bW5dLCBbcm93LCBjb2x1bW4gKyBjb21tZW50VG9rZW5zLmNsb3NlLmxlbmd0aF0pO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgYmxvY2tDb21tZW50T3BlblJhbmdlO1xuICAgICAgICBmb3IgKGxldCByb3cgPSByYW5nZS5zdGFydC5yb3c7ICFibG9ja0NvbW1lbnRPcGVuUmFuZ2UgJiYgcm93ID49IDA7IHJvdy0tKSB7XG4gICAgICAgICAgbGV0IGxpbmUgPSBidWZmZXIubGluZUZvclJvdyhyb3cpO1xuICAgICAgICAgIGZvciAoXG4gICAgICAgICAgICBsZXQgY29sdW1uID0gcm93ID09PSByYW5nZS5zdGFydC5yb3dcbiAgICAgICAgICAgICAgPyAoXG4gICAgICAgICAgICAgICAgYmxvY2tDb21tZW50Q2xvc2VSYW5nZSAmJiByb3cgPT09IGJsb2NrQ29tbWVudENsb3NlUmFuZ2Uuc3RhcnQucm93XG4gICAgICAgICAgICAgICAgICAvLyBQeXRob24gaGFzIHRoZSBzYW1lIHRva2VucyBmb3IgYmxvY2sgc3RyaW5nIGJlZ2luIGFuZCBlbmQsIHNvIHdlIG5lZWQgYW4gZXh0cmEgc2FuaXR5IGNoZWNrLlxuICAgICAgICAgICAgICAgICAgLy8gSWYgZW5kIHRva2VuIGlzIGF0IHRoZSBiZWdpbm5pbmcgb2YgYSBsaW5lIChjb2x1bW4gMCksIHNraXAgdG8gdGhlIGxpbmUgYWJvdmUgdG8gYXZvaWQgbWF0Y2hpbmcgdGhlIGVuZCB0b2tlbiBhcyB0aGUgYmVnaW4gdG9rZW4gYXMgd2VsbC5cbiAgICAgICAgICAgICAgICAgID8gKGJsb2NrQ29tbWVudENsb3NlUmFuZ2Uuc3RhcnQuY29sdW1uIC0gMSA+IDAgPyBibG9ja0NvbW1lbnRDbG9zZVJhbmdlLnN0YXJ0LmNvbHVtbiAtIDEgOiAoLS1yb3csIGxpbmUgPSBidWZmZXIubGluZUZvclJvdyhyb3cpLCBsaW5lLmxlbmd0aCkpXG4gICAgICAgICAgICAgICAgICA6IE1hdGgubWluKHJhbmdlLnN0YXJ0LmNvbHVtbiArIGNvbW1lbnRUb2tlbnMub3Blbi5sZW5ndGgsIGxpbmUubGVuZ3RoKVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgIDogbGluZS5sZW5ndGg7XG4gICAgICAgICAgICAoY29sdW1uID0gbGluZS5sYXN0SW5kZXhPZihjb21tZW50VG9rZW5zLm9wZW4sIGNvbHVtbikpICE9PSAtMTtcbiAgICAgICAgICAgIGNvbHVtbi0tXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICBpZiAoaXNDb21tZW50RGVmaW5pdGlvblB1bmN0dWF0aW9uKFtyb3csIGNvbHVtbl0pKSB7XG4gICAgICAgICAgICAgIGJsb2NrQ29tbWVudE9wZW5SYW5nZSA9IG5ldyBSYW5nZShbcm93LCBjb2x1bW5dLCBbcm93LCBjb2x1bW4gKyBjb21tZW50VG9rZW5zLm9wZW4ubGVuZ3RoXSk7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChibG9ja0NvbW1lbnRDbG9zZVJhbmdlKSB7XG4gICAgICAgICAgaWYgKHBhZGRpbmcpIHtcbiAgICAgICAgICAgIGNvbnN0IGJsb2NrQ29tbWVudENsb3NlUGFkZGVkUmFuZ2VTdGFydCA9IG5ldyBQb2ludChibG9ja0NvbW1lbnRDbG9zZVJhbmdlLnN0YXJ0LnJvdywgYmxvY2tDb21tZW50Q2xvc2VSYW5nZS5zdGFydC5jb2x1bW4gLSBwYWRkaW5nLmxlbmd0aCk7XG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICghYmxvY2tDb21tZW50T3BlblJhbmdlIHx8IGJsb2NrQ29tbWVudENsb3NlUGFkZGVkUmFuZ2VTdGFydC5jb21wYXJlKGJsb2NrQ29tbWVudE9wZW5SYW5nZS5lbmQpID49IDApXG4gICAgICAgICAgICAgICYmIGJ1ZmZlci5nZXRUZXh0SW5SYW5nZShbYmxvY2tDb21tZW50Q2xvc2VQYWRkZWRSYW5nZVN0YXJ0LCBibG9ja0NvbW1lbnRDbG9zZVJhbmdlLnN0YXJ0XSkgPT09IHBhZGRpbmdcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICBibG9ja0NvbW1lbnRDbG9zZVJhbmdlLnN0YXJ0ID0gYmxvY2tDb21tZW50Q2xvc2VQYWRkZWRSYW5nZVN0YXJ0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBidWZmZXIuZGVsZXRlKGJsb2NrQ29tbWVudENsb3NlUmFuZ2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGJsb2NrQ29tbWVudE9wZW5SYW5nZSkge1xuICAgICAgICAgIGlmIChwYWRkaW5nKSB7XG4gICAgICAgICAgICBjb25zdCBibG9ja0NvbW1lbnRPcGVuUGFkZGVkUmFuZ2VFbmQgPSBuZXcgUG9pbnQoYmxvY2tDb21tZW50T3BlblJhbmdlLmVuZC5yb3csIGJsb2NrQ29tbWVudE9wZW5SYW5nZS5lbmQuY29sdW1uICsgcGFkZGluZy5sZW5ndGgpO1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAvLyBUaGlzIHNhbml0eSBjaGVjayBhbHNvIHByZXZlbnRzIGV4Y2Vzc2l2ZWx5IHJlbW92aW5nIFwib3ZlcmxhcHBpbmdcIiBzdGFydC9lbmQgcGFkZGluZy5cbiAgICAgICAgICAgICAgLy8gRS5nLjogXCIvKiAqLyBhXCIgPT4gXCIgYVwiIGluc3RlYWQgb2YgXCJhXCJcbiAgICAgICAgICAgICAgKCFibG9ja0NvbW1lbnRDbG9zZVJhbmdlIHx8IGJsb2NrQ29tbWVudE9wZW5QYWRkZWRSYW5nZUVuZC5jb21wYXJlKGJsb2NrQ29tbWVudENsb3NlUmFuZ2Uuc3RhcnQpIDw9IDApXG4gICAgICAgICAgICAgICYmIGJ1ZmZlci5nZXRUZXh0SW5SYW5nZShbYmxvY2tDb21tZW50T3BlblJhbmdlLmVuZCwgYmxvY2tDb21tZW50T3BlblBhZGRlZFJhbmdlRW5kXSkgPT09IHBhZGRpbmdcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICBibG9ja0NvbW1lbnRPcGVuUmFuZ2UuZW5kID0gYmxvY2tDb21tZW50T3BlblBhZGRlZFJhbmdlRW5kO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBidWZmZXIuZGVsZXRlKGJsb2NrQ29tbWVudE9wZW5SYW5nZSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgLy8gRWxzZSwgd3JhcCBzZWxlY3Rpb24gd2l0aCBibG9jayBjb21tZW50LlxuICAgICAgYnVmZmVyLmluc2VydChyYW5nZS5lbmQsIHBhZGRpbmcgKyBjb21tZW50VG9rZW5zLmNsb3NlKTtcbiAgICAgIGJ1ZmZlci5pbnNlcnQocmFuZ2Uuc3RhcnQsIGNvbW1lbnRUb2tlbnMub3BlbiArIHBhZGRpbmcpO1xuXG4gICAgICAvLyBVbnNlbGVjdCB0aGUgb3BlbmluZyBhbmQgY2xvc2luZyBjb21tZW50IHRva2Vucy5cbiAgICAgIGNvbnN0IHN0YXJ0Um93Q29sdW1uT2Zmc2V0ID0gY29tbWVudFRva2Vucy5vcGVuLmxlbmd0aCArIHBhZGRpbmcubGVuZ3RoO1xuICAgICAgc2VsZWN0aW9uLnNldEJ1ZmZlclJhbmdlKFtcbiAgICAgICAgW3JhbmdlLnN0YXJ0LnJvdywgcmFuZ2Uuc3RhcnQuY29sdW1uICsgc3RhcnRSb3dDb2x1bW5PZmZzZXRdLFxuICAgICAgICBbcmFuZ2UuZW5kLnJvdywgcmFuZ2UuZW5kLmNvbHVtbiArIChyYW5nZS5zdGFydC5yb3cgPT09IHJhbmdlLmVuZC5yb3cgPyBzdGFydFJvd0NvbHVtbk9mZnNldCA6IDApXVxuICAgICAgXSk7XG4gICAgfVxuICB9KTtcblxuXG4gIGZ1bmN0aW9uIGlzSW5zaWRlQmxvY2tDb21tZW50KHBvc2l0aW9uKSB7XG4gICAgY29uc3Qgc2NvcGVzID0gZ2V0UG9zaXRpb25TY29wZXMocG9zaXRpb24pO1xuICAgIGNvbnN0IGNvbW1lbnRTY29wZVByZWZpeCA9IGAke2lzUHl0aG9uU291cmNlKHNjb3BlcykgPyAnc3RyaW5nLnF1b3RlZC5zaW5nbGUnIDogJ2NvbW1lbnQnfS5ibG9jay5gO1xuICAgIHJldHVybiBzY29wZXMuc29tZSgoc2NvcGUpID0+IHNjb3BlLnN0YXJ0c1dpdGgoY29tbWVudFNjb3BlUHJlZml4KSk7XG4gIH1cblxuICBmdW5jdGlvbiBpc0NvbW1lbnREZWZpbml0aW9uUHVuY3R1YXRpb24ocG9zaXRpb24pIHtcbiAgICBjb25zdCBzY29wZXMgPSBnZXRQb3NpdGlvblNjb3Blcyhwb3NpdGlvbik7XG4gICAgY29uc3QgY29tbWVudFB1bmN0dWF0aW9uU2NvcGVQcmVmaXggPSBgcHVuY3R1YXRpb24uZGVmaW5pdGlvbi4ke2lzUHl0aG9uU291cmNlKHNjb3BlcykgPyAnc3RyaW5nJyA6ICdjb21tZW50J30uYDtcbiAgICByZXR1cm4gc2NvcGVzLnNvbWUoKHNjb3BlKSA9PiBzY29wZS5zdGFydHNXaXRoKGNvbW1lbnRQdW5jdHVhdGlvblNjb3BlUHJlZml4KSk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRQb3NpdGlvblNjb3Blcyhwb3NpdGlvbikge1xuICAgIHJldHVybiBlZGl0b3Iuc2NvcGVEZXNjcmlwdG9yRm9yQnVmZmVyUG9zaXRpb24ocG9zaXRpb24pLmdldFNjb3Blc0FycmF5KCk7XG4gIH1cblxuICBmdW5jdGlvbiBpc0F0Q2xvc2VDb21tZW50VG9rZW4ocG9zaXRpb24sIGNsb3NlQ29tbWVudFRva2VuKSB7XG4gICAgcmV0dXJuIHBvc2l0aW9uLmNvbHVtbiA+PSBjbG9zZUNvbW1lbnRUb2tlbi5sZW5ndGhcbiAgICAgICYmIGJ1ZmZlci5nZXRUZXh0SW5SYW5nZShbW3Bvc2l0aW9uLnJvdywgcG9zaXRpb24uY29sdW1uIC0gY2xvc2VDb21tZW50VG9rZW4ubGVuZ3RoXSwgcG9zaXRpb25dKSA9PT0gY2xvc2VDb21tZW50VG9rZW5cbiAgICAgICYmIGlzQ29tbWVudERlZmluaXRpb25QdW5jdHVhdGlvbihbcG9zaXRpb24ucm93LCBwb3NpdGlvbi5jb2x1bW4gLSAxXSk7XG4gIH1cblxuICBmdW5jdGlvbiBpc1B5dGhvblNvdXJjZShzY29wZXMpIHtcbiAgICByZXR1cm4gc2NvcGVzWzBdID09PSAnc291cmNlLnB5dGhvbic7XG4gIH1cblxuICBmdW5jdGlvbiBpc1B5dGhvblB1bmN0dWF0aW9uRGVmaW5pdGlvblN0cmluZ0JlZ2luKHNjb3BlKSB7XG4gICAgcmV0dXJuIHNjb3BlID09PSAncHVuY3R1YXRpb24uZGVmaW5pdGlvbi5zdHJpbmcuYmVnaW4ucHl0aG9uJztcbiAgfVxuXG4gIGZ1bmN0aW9uIGlzUHl0aG9uU3RyaW5nQmxvY2tCZWdpbihwb3NpdGlvbikge1xuICAgIHJldHVybiBpc0luc2lkZUJsb2NrQ29tbWVudChwb3NpdGlvbikgJiYgKFxuICAgICAgZ2V0UG9zaXRpb25TY29wZXMocG9zaXRpb24pLnNvbWUoaXNQeXRob25QdW5jdHVhdGlvbkRlZmluaXRpb25TdHJpbmdCZWdpbikgfHxcbiAgICAgIC8vIEF0b20gZG9lcyBub3QgaWRlbnRpZnkgdGhlIHBvc2l0aW9uIGF0IHRoZSBlbmQgb2YgdGhlIGJlZ2luIHRva2VuIGFzIHBhcnQgb2YgaXRzIHNjb3BlLCB0aGVyZWZvcmUgd2UgY2hlY2sgb25lIGNvbHVtbiB0byB0aGUgbGVmdCBhcyB3ZWxsLlxuICAgICAgKHBvc2l0aW9uLmNvbHVtbiA+IDAgJiYgZ2V0UG9zaXRpb25TY29wZXMoW3Bvc2l0aW9uLnJvdywgcG9zaXRpb24uY29sdW1uIC0gMV0pLnNvbWUoaXNQeXRob25QdW5jdHVhdGlvbkRlZmluaXRpb25TdHJpbmdCZWdpbikpXG4gICAgKTtcbiAgfVxufVxuIl19